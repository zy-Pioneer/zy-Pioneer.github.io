---
title: IOT固件仿真测试方法
date: 2024-11-20
updated: 2024-11-20
tags: [漏洞挖掘]
categories: [论文笔记] 
---

## 基于仿真的测试方法及其挑战
固件仿真是近年来的一项新兴技术。模拟器允许安全研究人员在没有硬件的情况下运行嵌入式软件。大多数动态测试通常都伴随着破坏性。例如，模糊测试会导致设备反复进入崩溃状态。因此，对于脆弱且昂贵的物联网设备，仿真和动态测试是一个有吸引力的解决方案。然而，成功的仿真并不像将固件导入仿真器那么简单。它将面临许多现实世界环境限制带来的挑战。例如，不统一的固件开发原则导致需要手动定制仿真固件所需的仿真器。此外，在模拟器上部署各种测试工具并测试正在运行的固件也具有挑战性。

进行仿真测试需要解决一下四个问题：

1. 获取固件；
2. 外部硬件及外围设备；
3. 大规模测试；
4. 检测漏洞。

## 固件获取
固件是整个仿真过程的关键。许多现有方法讨论如何进行仿真，但忽略了固件获取过程。为了保护产品的安全，大多数厂家并没有发布相关的固件。而且，物联网设备的各种调试端口被制造商封锁，以防止固件泄露。因此，获取目标固件具有挑战性。为了克服这一挑战，研究人员提出了以下不同的解决方案：

1. 互联网上有很多固件的镜像可以下载，但通常都并不完善；
2. 固件进行更新时会下载最新固件到设备上，可以通过网络流量拦截的方式获取，但通常都会被加密或只是下载补丁而不是完整的固件。

## 外部硬件及外围设备
 由于固件需要与特定的硬件外围设备交互，而这些外围设备在虚拟化器（如QEMU）中可能无法得到充分仿真，因此有些固件无法在虚拟环境中正常仿真。此外，许多设备都定制了自己的固件，导致其体系结构和内核标准不一致，使得仿真变得更加复杂和多样化。  因此分为部分仿真和完全仿真：

> 1. 部分仿真  
例子：嵌入式设备的固件分析
>
> 假设你正在分析一个智能家居设备的固件，比如智能灯泡的固件。这个固件依赖于嵌入式硬件（如LED控制芯片、无线通信模块等）来实现其功能。使用部分仿真的方法，你可能只仿真固件的部分功能，比如固件的启动过程、操作系统的初始化或一些核心逻辑（如处理指令或控制灯泡开关的代码）。
>
> 部分仿真的一个常见做法是跳过固件中对特定硬件的调用，这些硬件在虚拟环境中无法被精确仿真。例如，QEMU 可能无法仿真无线通信模块。因此，部分仿真可以忽略或模拟这些外设的存在，而只聚焦于固件的软件部分，从而分析出设备的部分行为。
>
> 优势：这种方法能够快速获得关于固件的一些信息，而不需要精确仿真所有硬件。但它的局限性在于，无法分析固件与硬件的深层次交互，比如无法仿真出固件如何控制LED灯或与Wi-Fi模块通信的行为。
>
> 2. 完全仿真  
例子：路由器固件的全仿真
>
> 假设你正在对路由器固件进行安全分析。路由器的固件往往与多个外围设备交互，例如网卡、交换芯片、USB接口等。在这种情况下，完全仿真方法试图精确仿真固件与这些外设的所有交互。
>
> 例如，QEMU 通过仿真ARM架构，可以完整地仿真路由器固件的启动过程、驱动程序加载、网络接口初始化、无线网卡和交换芯片的工作流程等。为实现这一点，仿真环境可能需要定制设备模型，甚至模拟特定硬件的寄存器行为，以便精确还原固件的工作方式。
>
> 优势：完全仿真可以提供更高的精确度，特别适合进行复杂的固件安全分析或逆向工程研究。分析人员可以模拟设备的真实行为，包括固件如何与硬件协作。这有助于发现隐藏在硬件交互中的漏洞或后门，例如网络接口的安全漏洞或USB接口的未授权访问问题。
>

### 部分仿真
在嵌入式设备的漏洞挖掘中，由于外设的复杂性和硬件与软件的紧密结合，完全仿真往往困难重重。因此，部分仿真成为了解决这一问题的重要方法。以下是对 PROSPECT、AVATAR、SURROGATES 和 ECMO 等几种部分仿真方法的详细描述：

1. PROSPECT  
概述：  
PROSPECT 是一个能够克服仿真外设困难的系统。它的核心思想是将固件对外设的硬件访问透明地从主机系统转发到虚拟机。这种转发机制使得嵌入式软件能够在虚拟环境中运行，而无需了解具体外设的操作细节。

技术原理：  
PROSPECT 的部分仿真工作流程如下：

在仿真器中，固件继续运行，并发出与外设的交互请求。这些请求通常是通过I/O指令或存储器映射的外设访问实现的。  
PROSPECT 将这些外设访问请求捕获并透明地转发到真实的外设硬件。外设硬件响应后，其结果会被返回给虚拟机中的固件，仿真器接收并处理该结果，就好像外设实际上是通过仿真器直接控制的一样。  
应用场景：  
PROSPECT 适用于那些固件深度依赖专有外设的场景，特别是复杂的嵌入式设备，如物联网设备或工业控制系统。通过这种透明转发机制，固件能够在不完全仿真外设的情况下运行，并保持其预期的功能行为。

2. AVATAR  
概述：  
AVATAR 是一个仿真框架，它允许仿真器和真实外设硬件协同工作，以实现固件的动态分析。AVATAR 的核心理念是在仿真器中执行固件的同时，将I/O访问请求转发给真实的嵌入式设备，从而提高仿真精度和性能。

技术原理：  
AVATAR 的工作机制包括：

I/O 转发：当仿真器中运行的固件发出I/O访问指令时，AVATAR 会将这些访问请求转发给真实的外设设备。例如，访问网络接口、存储设备或传感器。  
动态优化：AVATAR 动态优化代码和数据在仿真环境和真实硬件之间的分布。仿真器处理固件的主要逻辑部分，而外设交互则委托给真实的嵌入式设备。这种分布优化使得仿真性能显著提高。  
优势：  
AVATAR 不仅能够提高仿真的效率，还可以在仿真中实现动态分析。它能够捕获固件的执行路径、检测潜在漏洞，并通过外设的真实行为进行测试。由于部分功能是在真实硬件上执行的，AVATAR 能够提供与完全仿真器无法实现的高精度分析。

3. SURROGATES  
概述：  
SURROGATES 是基于 AVATAR 的进一步优化版本，它通过加强外部设备与固件的连接来提升仿真的效率和稳定性。SURROGATES 专注于解决仿真中常见的中断处理、DMA（直接内存访问）以及时钟同步等问题。

技术原理：  
SURROGATES 的关键创新点是使用了自定义的低延迟 FPGA 桥接器。它将宿主机的外围组件互连（PCI）总线与待测试系统连接起来，使得仿真器能够更加有效地访问固件的外设。

低延迟通信：FPGA 桥接器大大减少了仿真环境与真实外设之间的通信延迟，从而增强了仿真的实时性和精确性。  
问题解决：SURROGATES 通过优化整个仿真系统，解决了以前仿真器中的常见问题，例如中断处理不准确、DMA 操作缺失以及时钟同步不良等。这使得仿真器在更复杂的环境中也能稳定运行。  
应用场景：  
SURROGATES 在需要极高仿真精度的场景中表现尤为突出。例如，它能够有效仿真高速数据传输设备，复杂的多设备通信系统等。通过优化外设的仿真和硬件访问，SURROGATES 能够支持更多类型的嵌入式设备仿真，并提高分析效率。

4. ECMO  
概述：  
ECMO 是另一种基于部分仿真的系统，它提出了一种外设移植技术，目的是减少在QEMU等仿真器中手动添加外设仿真模型的复杂性。

技术原理：  
ECMO 的核心思想是将特定外设的驱动程序移植到目标固件的内核二进制文件中。它不需要为每个外设编写专门的仿真代码，而是通过将真实外设的驱动直接嵌入固件，使得仿真器能够更好地处理外设交互。

外设移植：ECMO 将外设的仿真模型和驱动程序移植到固件内核中，从而简化了复杂外设的仿真过程。这种方法使仿真器能够无缝访问外设，而不需要在仿真器中逐一实现每个外设的行为。  
双组件移植：ECMO 通过将外设的仿真模型移植到 QEMU，同时将设备驱动程序移植到固件内核中，成功减少了手动仿真代码编写的需求。  
优势：  
ECMO 的移植技术有效解决了仿真中外设复杂性的瓶颈。它减少了在仿真器中逐个实现外设功能的需求，能够加快仿真开发的速度，并且能够更灵活地处理复杂的固件与外设交互。

总结  
以上几种部分仿真方法通过不同的技术手段，解决了嵌入式设备外设仿真难的问题。PROSPECT 提供了透明的外设访问转发机制，AVATAR 通过动态优化提高了仿真效率，SURROGATES 通过低延迟硬件桥接器和系统优化增强了稳定性，而 ECMO 则通过外设驱动移植简化了仿真配置。这些方法的结合为嵌入式设备的固件分析和漏洞挖掘提供了强大的工具支持，尤其在无法完全仿真外设时，部分仿真成为了非常有效的替代方案。



### 完全仿真
为了完全模拟固件，Firmadyne [22] 从设备中提取文件系统，并将其放入与 QEMU 一起运行的预编译通用 Linux 内核中。由于全仿真的可扩展性，Firmadyne 可以对目标固件进行大规模测试。 Firmadyne 在 69 个固件映像上发现了 14 个未知漏洞。 ARM-X[95]在仿真方面采用了与Fimadyne类似的思路，但需要用户提供更多的信息和配置。而且ARM-X只能用于ARM架构的设备，并且需要固件中的rootfs和NVRAM作为支持。 Pretender [63] 是一个在虚拟环境中自动重新托管各种嵌入式系统固件的框架。它记录物理硬件和固件之间的交互，然后使用这些记录通过机器学习来构建模型来描述每个外围设备。因此，Pretender可以完全将固件放置在虚拟化环境中，不需要保持对硬件设备的长期访问。



## 大规模测试
在模型外围设备时，有些物联网设备系统没有外围设备，但有些系统可能连接到可编程逻辑控制器（PLC）、FPGA、传感器、数据库和许多其他外围设备。许多部分仿真方法通常需要手动操作，其中包括将方法扩展到大规模测试的繁重工程工作，因此会存在挑战性。

目前有多种方法来帮助进行大规模测试，Laelaps 引入符号执行协助外设仿真，可以在无需先验知识的情况下运行各种固件，但只能在短期执行（并不贯穿固件的整个运行，而是只在关键点执行），路径过长会存在依赖爆炸的问题。P2IM是一个无需硬件即可独立测试固件的软件框架。它抽象外围设备并根据自动生成的模型，动态处理固件 I/O。它将目标固件及其内存映射作为输入，并通过将现成的模糊器（即 AFL）的输入提供给外围设备来模糊代码。



## 检测漏洞
###  漏洞检测的挑战
在虚拟环境中进行漏洞检测时，研究人员面临多个挑战。虽然仿真技术可以帮助更好地执行固件的安全分析，但由于各种限制，这些漏洞检测的应用仍然存在一定的困难。这些挑战包括：

+ 驱动程序中的错误处理代码难以触发，通常在极端情况下才会暴露漏洞。
+ 某些物联网设备中嵌入的Web应用服务可能存在大量隐藏的安全漏洞。
+ 针对设备与硬件交互边界的漏洞检测通常不涉及系统调用，难以在现有检测方法中被发现。



### 漏洞检测的技术与方法
为了克服这些挑战，研究人员提出了以下几种主要技术和方法：

#### （1）**驱动程序中的错误处理检测（Error Handling in Driver）**
+ **SymDrive**：这一框架通过符号执行来测试Linux设备驱动程序。它使用静态分析与源代码转换，显著减少了测试新驱动程序时所需的手动调整工作。SymDrive会自动化检测固件中设备驱动程序的错误处理部分。
+ **IFIZZ**：通过模糊测试来专门针对错误处理代码进行检测。它采用状态感知和受限错误生成的方式，有效地覆盖了更深的错误路径。
+ **FIFUZZ**：这是另一个模糊测试框架，它通过上下文敏感的故障注入方法，能够在复杂触发场景下找到隐藏的深层次错误。

#### （2）**Web接口漏洞检测（Web Interface Vulnerability Detection）**
+ **FIRMADYNE**：该框架通过自动化动态分析方法检测嵌入式固件中的内置Web应用服务漏洞。它通过仿真运行固件，并自动检测固件中Web接口的安全漏洞，如缓冲区溢出、命令注入等问题。
+ **FirmFuzz**：一个专门为Linux固件设计的独立仿真与自动化动态分析框架。它使用基于灰盒的生成式模糊测试方法，结合静态分析和系统监控来检测固件中Web应用程序的漏洞。

#### （3）**其他检测技术（Other Detection Techniques）**
+ **FIRM-AFL**：通过增强的进程仿真技术来解决系统仿真中的性能瓶颈，并启用POSIX兼容的固件模糊测试。相比全系统仿真，FIRM-AFL的检测吞吐量平均提升了8.2倍。
+ **PeriScope**：这一方法用于检测设备与硬件交互边界的漏洞。PeriScope通过挂钩固件内核的页面错误处理机制，检测和记录设备驱动与硬件之间的通信流量。它还引入了PeriFuzz框架，用于模拟针对外围设备的攻击。

现在主要讨论驱动程序中的错误处理检测方法，详细分析 FIFUZZ 的具体实现。



![](https://raw.githubusercontent.com/zy-Pioneer/BlogImage/main/img/2025/01/c9ca1e83.png)

### 








