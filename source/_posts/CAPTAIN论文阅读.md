
---
title: Incorporating Gradients to Rules_ Towards Lightweight, Adaptive Provenance-based Intrusion Detection
date: 2025-01-14
tags: [安全, 入侵检测, PIDS]
categories: [论文笔记]
---

本文提出了一种名为CAPTAIN的基于规则的溯源入侵检测系统，该系统旨在解决现有PIDS面临的高误报率和难以适应不同环境等问题。

## motivation
###  “**Grey” Nodes**
随着云计算的普及，很多合法的网络连接和云服务（如AWS Lambda、Cloudflare Workers）被广泛使用，但攻击者也可以利用这些服务作为其命令与控制（C2）服务器的中介。这使得现有的基于规则的PIDS难以区分合法与恶意的外部IP连接。传统系统通常会根据简单的信任度规则对节点进行分类，但过于粗糙的规则往往会导致误报或漏报。

+ **解决方案动机：** CAPTAIN通过引入更细粒度的标签（如将节点信任度设置为0到1之间的浮点数），能够更灵活地反映不同程度的信任，从而避免误报或漏报。

###  **依赖爆炸问题 (Dependency Explosion)**
依赖爆炸是指单个可疑事件可能导致大量系统实体被标记为可疑，尤其是在复杂的依赖链中。一个恶意事件可能引发整个依赖链上的实体被怀疑为恶意，而很多情况下这些实体其实是正常的。现有的解决方案大多采用简单的事件白名单或手动划分攻击阶段，但这些方法往往需要大量的应用程序/操作系统的调试，无法在实际系统中大规模使用。

+ **解决方案动机：** CAPTAIN通过引入可调节的标签传播速率（Tag Propagation Rate），允许根据事件的类型和上下文来调整恶意标签的传播力度，从而防止不必要的传播引发依赖爆炸。

###  **自定义警报触发问题 (Customized Alarm Triggering)**
现有的基于规则的PIDS在触发警报时，通常对所有事件应用统一的规则和阈值。然而，在不同的情境下，同一种行为可能是正常的或恶意的。例如，`sshd`进程执行脚本是常见的行为，而`firefox`进程执行脚本则是异常的。传统的规则系统无法为不同的事件设定不同的阈值，从而容易导致漏报或误报。

+ **解决方案动机：** CAPTAIN引入了自适应警报触发机制，允许为不同的事件和进程设置特定的警报触发阈值，以区分正常行为和异常行为。通过这种自定义的阈值，CAPTAIN能够减少不必要的警报，并提高对异常行为的敏感性。

## CAPTAIN 系统设计
![](https://cdn.nlark.com/yuque/0/2024/png/46744832/1728365003605-d50496fe-3e23-4efe-a5f2-69526c0e18a8.png)

CAPTAIN系统的设计主要分为两个部分：

+ **检测模块（Detection Module）**：负责处理审计日志，生成溯源图并进行实时入侵检测。
+ **学习模块（Learning Module）**：在训练阶段对检测模块进行优化，通过梯度下降算法自动调整自适应参数，以减少误报并提高检测精度。

### **检测模块的设计**
检测模块的核心功能是通过标签传播对系统实体（进程、文件、网络连接等）进行实时监控和检测。该模块分为以下三个主要组件：

#### **标签初始化（Tag Initialization）**
CAPTAIN为每个系统实体分配初始的安全标签。具体来说：

+ **数据标签 (Data Tags)**：表示系统实体的机密性和完整性。
+ **代码标签 (Code Tags)**：仅用于进程，表示进程代码的可信度。

系统实体首次出现在溯源图时，会根据其特征（如进程名、文件路径、IP地址等）分配初始标签。标签初始化的具体规则由自适应参数 **A** 决定，而该参数会在训练阶段根据反馈进行调整。

#### **标签传播（Tag Propagation）**
当系统中发生事件时，CAPTAIN会根据预定义的规则在节点之间传播标签。传播的方式有两种：

+ **数据流传播**：数据从源节点传播到目标节点（如进程读取文件时，文件的标签会影响进程的标签）。
+ **控制流传播**：进程间的交互也会传播标签（如进程执行另一个进程时，代码的可信度会传播）。

标签传播的强度由 **传播速率参数 (G)** 控制。CAPTAIN可以为每条边设置不同的传播速率，以防止标签不必要地过度传播，特别是在应对“依赖爆炸”问题时，传播速率的自适应调整尤为关键。

#### **警报生成（Alarm Generation）**
CAPTAIN系统会根据标签的变化触发安全警报。当标签传播到某个节点，并且该节点的标签值超过了设定的阈值时，就会触发相应的警报。警报触发规则由 **阈值参数 (T)** 控制，可以根据不同的事件类型和实体特征调整触发阈值。

例如：

+ 当进程试图执行低完整性的代码时，系统可能会触发代码完整性相关的警报。
+ 当进程访问高机密性的数据时，系统会触发数据泄漏警报。

CAPTAIN能够为不同类型的系统事件设置灵活的阈值，从而减少误报，同时确保检测到真正的威胁。

### **学习模块的设计**
CAPTAIN的学习模块负责在训练阶段优化标签传播和警报触发的参数。通过对误报数据进行分析，该模块使用**梯度下降算法**来调整自适应参数（A, G, T），从而改进检测模块的性能。学习模块的主要功能包括：

#### **损失函数的定义（Loss Function）**
学习模块使用一个损失函数来衡量系统的检测效果。损失函数由两部分组成：

+ **误报项**：用于惩罚错误触发的警报。如果某个事件不应触发警报但触发了，该项会增加损失值。
+ **正则化项**：用于避免系统过度宽松，确保系统对恶意活动仍然保持敏感。通过将当前参数与默认初始值之间的差距最小化，CAPTAIN能够在减少误报的同时保持对攻击的敏感性。

#### **梯度计算（Gradient Calculation）**
CAPTAIN将检测过程建模为可微分的函数，以便在训练过程中计算自适应参数的梯度。通过这些梯度，系统能够使用梯度下降算法不断更新参数，从而优化标签传播和警报生成规则。

例如：

+ 对于节点的初始标签（A）的梯度，系统根据标签如何传播来调整初始值，以减少误报。
+ 对于边的传播速率（G），系统通过传播链上各节点的行为来计算传播速率的梯度，从而控制信息在系统中的传播程度。
+ 对于警报阈值（T），梯度用于调整系统对不同事件的敏感性，避免过多或过少的警报触发。

#### **训练与测试流程**
在训练阶段，CAPTAIN会基于良性数据进行训练。训练的结果是生成一个优化的自适应参数配置。在测试阶段，系统根据训练得出的最优参数对新的系统事件进行实时检测。

### 


